<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.1.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet author="michael.franklin" id="2022-11-10-postgres-refactor">

        <sql>
            CREATE TYPE ANALYSIS_STATUS AS ENUM('queued', 'in-progress', 'failed', 'completed', 'unknown');
            CREATE TYPE ANALYSIS_TYPE AS ENUM('qc', 'joint-calling', 'custom', 'gvcf', 'cram', 'es-index',
            'sv','analysis-runner');
            CREATE TYPE SAMPLE_SEQUENCING_TYPE AS ENUM('genome', 'exome', 'single-cell', 'mtseq', 'ont','wgs');
            CREATE TYPE SAMPLE_SEQUENCING_STATUS AS ENUM('unknown', 'received', 'sent-to-sequencing',
            'completed-sequencing', 'completed-qc', 'failed-qc', 'uploaded');
            CREATE TYPE SAMPLE_TYPE AS ENUM('blood', 'saliva');
        </sql>

        <!-- Project settings -->
        <createTable tableName="project">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(64)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column
                    name="gcp_id"
                    type="VARCHAR(255)"
            />
            <column
                    name="read_secret_name"
                    type="VARCHAR(255)"
            />
            <column
                    name="write_secret_name"
                    type="VARCHAR(255)"
            />
            <column
                    name="meta"
                    type="JSON"
            />
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Participants -->
        <createTable tableName="participant">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="external_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project" type="INT">
                <constraints nullable="false" foreignKeyName="fk_project_participant" references="project(id)"/>
            </column>
            <column
                    name="reported_sex"
                    type="int"
            />
            <column
                    name="reported_gender"
                    type="VARCHAR(255)"
            />
            <column
                    name="karyotype"
                    type="VARCHAR(255)"
            />
            <column
                    name="meta"
                    type="json"
                    defaultValue="{}"
            />
            <!-- Record keeping -->
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
                columnNames="project,external_id"
                tableName="participant"
                constraintName="UK_PARTICIPANT_SAMPLE_EXTERNALID"
                validate="true"
        />
        <!-- Samples -->
        <createTable tableName="sample">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="external_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project" type="INT">
                <constraints nullable="false" foreignKeyName="fk_project_sample" references="project(id)"/>
            </column>
            <column name="participant_id" type="INT">
                <constraints nullable="true" foreignKeyName="fk_participant_sample" references="participant(id)"/>
            </column>
            <column name="active" type="BOOLEAN"/>
            <column name="meta" type="JSON"/>
            <column name="type" type="SAMPLE_TYPE"/>

            <!-- Record keeping -->
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
                columnNames="project,external_id"
                tableName="sample"
                constraintName="UK_SAMPLE_PROJECT_EXTERNALID"
                validate="true"
        />

        <!-- Sample Sequencing  -->
        <createTable tableName="sample_sequencing">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="sample_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_sample_sequencing" references="sample(id)"/>
            </column>
            <column name="type" type="SAMPLE_SEQUENCING_TYPE">
                <constraints nullable="true"/>
            </column>
            <column name="status"
                    type="SAMPLE_SEQUENCING_STATUS">
                <constraints nullable="false"/>
            </column>
            <column name="meta" type="json"/>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Participant Phenotype -->
        <createTable tableName="participant_phenotypes">
            <column name="participant_id" type="INT">
                <constraints primaryKey="true" nullable="false" foreignKeyName="fk_participant_phenotype"
                             references="participant(id)"/>
            </column>
            <column name="hpo_term" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column
                    name="value"
                    type="JSON"
            />


            <!-- Record keeping -->
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
                tableName="participant_phenotypes"
                columnNames="participant_id,hpo_term,description"
                constraintName="UK_PARTICIPANT_PHENOTYPES_PID_HPO_DESCRIPTION"
        />


        <!-- Analysis -->
        <createTable tableName="analysis">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type" type="ANALYSIS_TYPE">
                <constraints nullable="false"/>
            </column>
            <column name="output" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="status" type="ANALYSIS_STATUS">
                <constraints nullable="false"/>
            </column>
            <column name="timestamp_completed" type="timestamp"/>
            <column
                    name="meta"
                    type="JSON"
                    defaultValue="{}"
            />
            <column
                    name="active"
                    type="BOOLEAN NOT NULL"
                    defaultValue="1"
            />
            <column
                    name="on_behalf_of"
                    type="VARCHAR(255)"
            />

            <column name="project" type="INT">
                <constraints nullable="false" foreignKeyName="fk_project_analysis" references="project(id)"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <createTable tableName="analysis_sample">
            <column name="analysis_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_analysis_sample" references="analysis(id)"/>
            </column>
            <column name="sample_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_analysis_sample_sample" references="sample(id)"/>
            </column>

        </createTable>

        <!-- Family -->
        <createTable tableName="family">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="external_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="project" type="INT">
                <constraints nullable="false" foreignKeyName="fk_project_family" references="project(id)"/>
            </column>
            <column name="description" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="coded_phenotype" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
                columnNames="project,external_id"
                tableName="family"
                constraintName="UK_FAMILY_PROJECT_EXTERNALID"
                validate="true"
        />
        <createTable tableName="family_participant">
            <column name="family_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_family_participant" references="family(id)"/>
            </column>
            <column name="participant_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_family_participant_participant"
                             references="participant(id)"/>
            </column>
            <column name="paternal_participant_id" type="INT">
                <constraints nullable="true" foreignKeyName="fk_family_participant_paternal"
                             references="participant(id)"/>
            </column>
            <column name="maternal_participant_id" type="INT">
                <constraints nullable="true" foreignKeyName="fk_family_participant_maternal"
                             references="participant(id)"/>
            </column>
            <column name="affected" type="INT">
                <constraints nullable="true"/>
            </column>
            <column name="notes" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

        </createTable>
        <createTable tableName="sample_sequencing_eid">
            <column name="project" type="INT">
                <constraints nullable="false" foreignKeyName="fk_sample_sequencing_eid_project"
                             references="project(id)"/>
            </column>
            <column name="sequencing_id" type="INT">
                <constraints nullable="false" foreignKeyName="fk_sample_sequencing_eid_sequence_id"
                             references="sample_sequencing(id)"/>
            </column>
            <column name="external_id" type="VARCHAR(255)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

        </createTable>
        <addPrimaryKey
                columnNames="sequencing_id,name"
                constraintName="PK_sample_sequencing_eid"
                tableName="sample_sequencing_eid"
                validate="true"
        />
        <addUniqueConstraint
                columnNames="project,external_id"
                tableName="participant"
                constraintName="UK_SAMPLE_SEQUENCING_EXTERNALID"
                validate="true"
        />
        <createIndex indexName="idx-analysis-type" tableName="analysis">
            <column name="type"/>
            <column name="project"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
